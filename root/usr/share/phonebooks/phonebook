#!/bin/bash

# Publish all configured phonebook into one phonebook

# use SCL version of PHP if NethVoice14 is installed
if [[ -f /etc/e-smith/db/configuration/defaults/nethvoice/LegacyMode ]]; then
    source /opt/rh/rh-php56/enable
fi

# empty phonebook table
PBOOKPASS=$(perl -e "use NethServer::Password; my \$password = NethServer::Password::store('PhonebookDBPasswd')  ; printf \$password;")
/usr/bin/mysql phonebook -upbookuser -p${PBOOKPASS} -e "DELETE FROM phonebook WHERE source IS NULL"

# Execute all custom scripts
for i in $(find /usr/share/phonebooks/scripts/); do
        if [ -f $i ] && [ -x $i ]; then
                $i
        fi
done

# Export data in ldap if requested
ldap_status=`/sbin/e-smith/config getprop phonebookjs status`
if [[ "X$ldap_status" == "Xenabled" ]]; then
        systemctl restart phonebookjs
fi

# Execute all custom scripts
for i in $(find /usr/share/phonebooks/post_scripts/); do
        if [ -f $i ] && [ -x $i ]; then
                $i
        fi
done

