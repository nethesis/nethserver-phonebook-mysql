#!/bin/bash

# Publish all configured phonebook into one phonebook

# empty phonebook table
PBOOKPASS=$(perl -e "use NethServer::Password; my \$password = NethServer::Password::store('PhonebookDBPasswd')  ; printf \$password;")
/usr/bin/mysql phonebook -upbookuser -p${PBOOKPASS} -e "truncate phonebook"


# Export sogo phonebook if requested
sogo=$(/sbin/e-smith/config getprop sogod status 2>/dev/null)
sogo_status=$(/sbin/e-smith/config getprop phonebook sogo 2>/dev/null)
if [[ "X$sogo_status" != "Xdisabled" && "X$sogo" == "Xenabled"  ]]; then
        /usr/share/phonebooks/sogo_export.php $sogo_status
fi

# Export nethcti phonebook if requested
nethcti_phonebook=$(/sbin/e-smith/config getprop phonebook nethcti 2>/dev/null)
nethcti_status=$(/sbin/e-smith/config getprop nethcti-server status 2>/dev/null)
if [[ "X$nethcti_phonebook" != "Xdisabled" && "X$nethcti_status" == "Xenabled" ]]; then
        /usr/share/phonebooks/nethcti_export.php
fi

# Export nethvoice speeddial if requested
nethvoice_speeddial=$(/sbin/e-smith/config getprop phonebook speeddial 2>/dev/null)
    if [[ "X$nethvoice_speeddial" == "Xenabled" && $(/sbin/e-smith/config show nethvoice 2>1 >/dev/null ; echo $?) == 0 ]] ; then
        /usr/share/phonebooks/speed_dial_export.php
    fi

# Export nethvoice extensions
nethvoice_extensions=$(/sbin/e-smith/config getprop phonebook extensions 2>/dev/null)
    if [[ "X$nethvoice_extensions" == "Xenabled" && $(/sbin/e-smith/config show nethvoice 2>1 >/dev/null ; echo $?) == 0 ]] ; then
        /usr/share/phonebooks/nethvoice_extensions_export.php
    fi


# Execute all custom scripts
for i in $(find /usr/share/phonebooks/scripts/); do
        if [ -f $i ] && [ -x $i ]; then
                $i
        fi
done

# Export data in ldap if requested
ldap_status=`/sbin/e-smith/config getprop phonebookjs status`
if [[ "X$ldap_status" == "Xenabled" ]]; then
        systemctl restart phonebookjs
fi

# Execute all custom scripts
for i in $(find /usr/share/phonebooks/post_scripts/); do
        if [ -f $i ] && [ -x $i ]; then
                $i
        fi
done

